---
title: "Samplesheet Investigation"
author: "Andrew Li Yim"
date: "6/6/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal of this markdown is to inspect the samplesheets belonging to PRJ0000008_CDTNFRESP and to see whether any confounding can be observed.
```{r setup, include=FALSE}
require(PerformanceAnalytics)
baseDir <- file.path("/home/ayliyim/archive/projects/PRJ0000008_CDTNFRESP")
outputDir <- file.path(baseDir, "output/00_samplesheet_inspection")
dir.create(outputDir)
```
The first step would be to import the samplesheet.
```{r Import samples}
smpls <- read.csv(file.path(baseDir, "data/infliximab/samples/samplesheet_PRJ0000008_CDTNFRESP_V1.csv"), row.names = 1)
```

#Cleaning
Select the covariates of interest. In other words, remove the columns that have only one value.
```{r Non-covariates}
variables <- apply(smpls, 2, table)
non_covs <- which(lapply(variables, length) == 1)
```
We observe that columns in `r names(non_covs)` contain only one single value and could thus not be a possible confound. Usually such columns are included for the experimenter's sake. We can therefore remove them from the samplesheet as they do not add much information for the analysis.
```{r Covariates of interest}
smpls_covs <- smpls[,-non_covs]
```
Some samples have "", whereas others are coded with NA. We need to ensure that all have the same value as this makes interpretation slightly easier. Changing NAs into "" makes it easier, as the latter will be converted into an actual value later on, making it easier for correlation analyses.
```{r NA conversion}
smpls_covs[is.na(smpls_covs)] <- ""
```
The next step would be to recode the variables into numerics, such that we can correlate them. One way of doing this is by converting the value to factor and then into a numeric (this has been implemented in rafalib's function `as.fumeric`)
```{r Recoding}
require(foreach)

smpls_rc <- foreach(i = 1:ncol(smpls_covs), .combine = cbind) %do% {
  feat <- smpls_covs[,i]
  if(class(feat) %in% c("character", "factor")){
    feat <- as.numeric(as.factor(feat))
  } 
  return(feat)
}
rownames(smpls_rc) <- rownames(smpls_covs)
colnames(smpls_rc) <- colnames(smpls_covs)
```

#Pairwise correlation
Finally, we can correlate the values to get an idea of the pairwise correlations among features
```{r Correlate}
smpls_cor <- cor(smpls_rc)
```
Here, we can get an impression of the correlation scores by visualizing it using a histogram to see whether any action must be taken.
```{r Histogram}
hist(smpls_cor, breaks = 100, main = "Correlations histogram", xlim = c(-1, 1))
```
We see some strong correlations, suggesting that some variables might be correlated. Note that this does not necessarily mean it is bad, but we would like to know why these values have such high correlations. This does mean that we might not be able to include these values in the model altogether as we might run the risk of collinear models (unless a nested model is implemented). 
What constitutes a strong correlation is obviously subjective, but we consider an absolute correlation coefficient above 0.5 worth investigating. As we are dealing with a symmetric matrix, we can simply extract the rows of the correlation matrix with absolute correlation coefficients > 0.5.
```{r Potential confounders}
high_correlations <- which(abs(smpls_cor) > 0.5, arr.ind = T)
high_correlations <- high_correlations[-which(high_correlations[,1] == high_correlations[,2]),]

pot_confounders <- unique(high_correlations[,1])

pot_conf_smpls_cor <- smpls_cor[pot_confounders, pot_confounders]
```
Now that we have made our selection, we can visualize the high correlation scores using a heatmap
```{r Correlation visualization}
require(pheatmap)
pheatmap(pot_conf_smpls_cor, clustering_distance_rows = "correlation", clustering_distance_cols = "correlation")
```

```{r Correlation with extra details}
chart.Correlation(smpls_rc)
```
Most of the pairwise correlations are OK (GSID and Plate, PatientID and SampleID) or simply random (GSID, Plate, SampleID). There are some correlations, that are worth investigating:
1) Plate and X
2) Azathiopurine and Age

#Block 1
```{r Block 1 overall}
block1 <- c("Plate", "X")

smpls[,block1]
```

```{r Block 1 pairwise}
plot(smpls[,block1[1]], smpls[,block1[2]], xlab = "Plate", ylab = "X")
```
There appears to be strong correlation between variable X and the plate number. I am not sure what X is, so I could not really estimate its potential impact on DNA methylation. It should not be too much of an issue as neither X nor plate affect methylation. If it were, then we would not be able to say whether changes associated to differences are due to plate or X.

#Block 2
```{r Block 2}
block2 <- c("Azathiopurine", "Age")

smpls[,block2]
```

```{r Block 2 pairwise}
chart.Correlation(smpls_rc[,block2])
```
Only one patient is on Azathiopurine, who happens to be the eldest.

#Conclusions
No serious confounding going on, some minor comments are:
*X and plate number are strongly correlated. Would warrant some investigation to understand what it means. 
*Age and Azathiopurine usage are mildly correlated.